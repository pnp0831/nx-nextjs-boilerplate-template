'use client';

import { useAppContext } from '@esp/contexts/app-context';
import NextLink from 'next/link';
import { forwardRef } from 'react';

import { onStart } from '../router-events';

// https://github.com/vercel/next.js/blob/400ccf7b1c802c94127d8d8e0d5e9bdf9aab270c/packages/next/src/client/link.tsx#L169
function isModifiedEvent(event: React.MouseEvent): boolean {
  const eventTarget = event.currentTarget as HTMLAnchorElement | SVGAElement;
  const target = eventTarget.getAttribute('target');
  return (
    (target && target !== '_self') ||
    event.metaKey ||
    event.ctrlKey ||
    event.shiftKey ||
    event.altKey || // triggers resource download
    (event.nativeEvent && event.nativeEvent.which === 2)
  );
}

const Link = forwardRef<HTMLAnchorElement, React.ComponentProps<'a'>>(function Link(
  { href, onClick, ...rest },
  ref
) {
  const { sidebarMobileOpen, toggleSidebarMobile } = useAppContext();

  const useLink = href && href.startsWith('/');

  if (!useLink) return <a href={href} onClick={onClick} {...rest} />;

  return (
    <NextLink
      href={href}
      onClick={(event) => {
        if (!isModifiedEvent(event)) {
          const { pathname, search, hash } = window.location;

          if (href !== pathname + search + hash) {
            onStart();
          }
        }

        if (onClick) onClick(event);

        if (sidebarMobileOpen) {
          toggleSidebarMobile();
        }
      }}
      {...rest}
      ref={ref}
    />
  );
});

Link.displayName = 'Link';

export default Link;
